<script>
fetch('https://raw.githubusercontent.com/yprosperi/auto-part-cross-referencing/main/assets/cross_reference.json')
    .then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    })
    .then(partsData => {
        console.log("‚úÖ Data Loaded Successfully:", partsData);

        let searchQuery = new URLSearchParams(window.location.search).get('query') || "";
        searchQuery = searchQuery.toUpperCase(); // Case insensitive search

        let matchedParts = [];

        // Search by both Part Number and Description
        partsData.forEach(entry => {
            let matchingParts = entry.Parts.filter(part =>
                part["Part Number"].toUpperCase().includes(searchQuery) || 
                entry.Description.toUpperCase().includes(searchQuery)
            );

            if (matchingParts.length > 0) {
                matchedParts.push({
                    "Description": entry.Description,
                    "Parts": matchingParts
                });
            }
        });

        console.log("üîç Matched Parts:", matchedParts);

        const resultsContainer = document.getElementById('resultsContainer');
        if (!resultsContainer) {
            console.error("‚ùå Error: 'resultsContainer' not found in the HTML.");
            return;
        }

        resultsContainer.innerHTML = ''; // Clear previous results

        // Ensure loadingSpinner exists before trying to hide it
        const loadingSpinner = document.getElementById('loadingSpinner');
        if (loadingSpinner) {
            loadingSpinner.style.display = "none"; // Hide spinner
        }

        if (matchedParts.length === 0) {
            resultsContainer.innerHTML = '<p>No results found.</p>';
            return;
        }

        // Display results
        matchedParts.forEach(entry => {
            const section = document.createElement('div');
            section.innerHTML = `<h2>${entry.Description}</h2>`;

            const ul = document.createElement('ul');
            entry.Parts.forEach(part => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>Part Number:</strong> ${part["Part Number"]} <br> <strong>Retailer:</strong> ${part["Parts Retailer"]}`;
                ul.appendChild(li);
            });

            section.appendChild(ul);
            resultsContainer.appendChild(section);
        });
    })
    .catch(error => {
        console.error('‚ùå Error loading JSON:', error);
        const loadingSpinner = document.getElementById('loadingSpinner');
        if (loadingSpinner) {
            loadingSpinner.style.display = "none"; // Hide spinner on error
        }
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) {
            resultsContainer.innerHTML = '<p>Error loading results.</p>';
        }
    });
</script>
