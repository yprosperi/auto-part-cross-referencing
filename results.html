<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
</head>
<body>
    <div class="container">
        <h1>Search Results</h1>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <p>Loading results...</p>
        </div>

        <!-- Results Box -->
        <div class="results-container" id="resultsContainer" aria-live="polite">
            <!-- Search results will be displayed here -->
        </div>

        <!-- Back to Search Button -->
        <a href="index.html" class="back-btn">üîô Back to Search</a>
    </div>

    <script>
    const resultsContainer = document.getElementById('resultsContainer');
    const loadingSpinner = document.getElementById('loadingSpinner');
    let matchedParts = [];
    let currentPage = 1;
    const resultsPerPage = 5;

    const queryParams = new URLSearchParams(window.location.search);
    const searchQuery = queryParams.get('query')?.toUpperCase() || "";
    const sortOption = queryParams.get('sort') || "";

    fetch('https://raw.githubusercontent.com/yprosperi/auto-part-cross-referencing/main/assets/cross_reference.json')
        .then(response => {
            if (!response.ok) throw new Error("Network response was not ok");
            return response.json();
        })
        .then(data => {
            console.log("‚úÖ Data loaded");

            // Flatten the data for fuzzy search
            const flatParts = [];
            data.forEach(entry => {
                entry.Parts.forEach(part => {
                    flatParts.push({
                        ...part,
                        Description: entry.Description
                    });
                });
            });

            // Fuzzy search setup
            const fuse = new Fuse(flatParts, {
                keys: ['Part Number', 'Description', 'Vehicle', 'Parts Retailer'],
                threshold: 0.3
            });

            const searchResults = fuse.search(searchQuery).map(result => result.item);

            // Group results by description
            const grouped = {};
            searchResults.forEach(part => {
                if (!grouped[part.Description]) {
                    grouped[part.Description] = [];
                }
                grouped[part.Description].push(part);
            });

            for (let desc in grouped) {
                matchedParts.push({
                    Description: desc,
                    Parts: grouped[desc]
                });
            }

            // Optional sort logic
            if (sortOption === "retailer") {
                matchedParts.forEach(entry => {
                    entry.Parts.sort((a, b) => a["Parts Retailer"].localeCompare(b["Parts Retailer"]));
                });
            } else if (sortOption === "partnumber") {
                matchedParts.forEach(entry => {
                    entry.Parts.sort((a, b) => a["Part Number"].localeCompare(b["Part Number"]));
                });
            }

            loadingSpinner.style.display = "none";
            if (matchedParts.length === 0) {
                resultsContainer.innerHTML = "<p>No results found.</p>";
                return;
            }

            renderResultsPage(currentPage);
        })
        .catch(error => {
            console.error("‚ùå Error loading JSON:", error);
            if (loadingSpinner) loadingSpinner.style.display = "none";
            if (resultsContainer) resultsContainer.innerHTML = '<p>Error loading results.</p>';
        });

    function renderResultsPage(page) {
        const startIndex = (page - 1) * resultsPerPage;
        const endIndex = startIndex + resultsPerPage;
        const resultsToShow = matchedParts.slice(startIndex, endIndex);

        resultsContainer.innerHTML = '';

        resultsToShow.forEach(entry => {
            const section = document.createElement('div');
            section.innerHTML = `<h2>${highlightMatch(entry.Description, searchQuery)}</h2>`;

            const ul = document.createElement('ul');
            entry.Parts.forEach(part => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <strong>Part Number:</strong> ${highlightMatch(part["Part Number"], searchQuery)} <br>
                    <strong>Retailer:</strong> ${part["Parts Retailer"] || "N/A"} <br>
                    <strong>Vehicle:</strong> ${part["Vehicle"] || "N/A"}
                `;
                ul.appendChild(li);
            });

            section.appendChild(ul);
            resultsContainer.appendChild(section);
        });

        renderPaginationControls();
    }

    function renderPaginationControls() {
        const totalPages = Math.ceil(matchedParts.length / resultsPerPage);
        const pagination = document.createElement('div');
        pagination.className = "pagination";

        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            if (i === currentPage) btn.classList.add("active");

            btn.addEventListener("click", () => {
                currentPage = i;
                renderResultsPage(currentPage);
            });

            pagination.appendChild(btn);
        }

        resultsContainer.appendChild(pagination);
    }

    function highlightMatch(text, keyword) {
        if (!text || !keyword) return text;
        const regex = new RegExp(`(${keyword})`, "gi");
        return text.replace(regex, '<mark>$1</mark>');
    }
    </script>
</body>
</html>

